<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
  <script type="text/javascript" src="/js/components.js"></script>
  <script type="text/javascript" src="/js/tasks.js"></script>

  <link rel="stylesheet" type="text/css" href="/css/components.css">
  <link rel="stylesheet" type="text/css" href="/css/app.css">

</head>
<body>

  <x-shiftbox shift="right">
    <aside>
      <menu id="sideMenu">
        <button data-action="new-column">New</button>
        <button>Theme</button>
        <button>Macro</button>
        <button>Equalz</button>
        <button>Offline</button>
      </menu>
    </aside>
    <section>
      <x-appbar><div>=</div><header id="header"></header><div>+</div></x-appbar>
      <x-slidebox>
        <x-slides></x-slides>
      </x-slidebox>
    </section>
  </x-shiftbox>

  <x-modal hidden overlay esc-hide><x-placeholder></x-placeholder></x-modal>

  <x-template name="task">
    <script type="template/script">
    </script>
    <script type="template/content">
      <p>{text}</p>
      <div class="tags">{tags}</div>
    </script>
  </x-template>

  <x-template name="task-edit">
    <script type="template/script">
      this.addTemplateListeners({
        'tap:delegate(button.update-task)': function(e){
          console.log('saved');
          e.templateTarget.parseText(e.target.parentNode.firstElementChild.value);
          e.templateTarget.setAttribute('template', 'task');
        }
      });
    </script>
    <script type="template/content">
      <textarea>{text} {tags}</textarea>
      <input type="color" name="favcolor">
      <button class="update-task">Save</button>
    </script>
  </x-template>

  <x-template name="new-column">
    <script type="template/script">
      this.addTemplateListeners({
        'tap:delegate(button.create-column)': function(e){
          var values = {};
          xtag.query(e.templateTarget, 'input').forEach(function(input){
            values[input.name] = input.value;
          });
          createColumn(values.columnTitle, values.filter, values.headerColor);
          modal.toggle();
        }
      });
    </script>
    <script type="template/content">
      <label for="columnTitle">Name</label>
      <input type="text" name="columnTitle" >
      <label for="filter">Filter</label>
      <input type="text" name="filter" >
      <label for="filter">Color</label>
      <input type="color" name="headerColor" >
      <br/>
      <button class="create-column">Save</button>
    </script>
  </x-template>

</body>

<script type="text/javascript">

  var slidebox = document.querySelector('x-slidebox');
  var appbar = document.querySelector('x-appbar');
  var shiftbox = document.querySelector('x-shiftbox');
  var modal = document.querySelector('x-modal');

  document.addEventListener('DOMComponentsLoaded', function(){
    TaskFilter.myFilters(function(err, columns){
      columns.forEach(function(data){
        createColumn(data.name, data.filter, data.headerColor);
      });
      setHeader();
    });
  });

  /*var colorSelector = document.querySelector('#colorSelector');
  colorSelector.addEventListener('change', function(){
    appbar.style.backgroundColor = this.value;
    var selected = slidebox.querySelector('x-slide[selected]');
    selected.firstElementChild.headerColor = this.value;
  });*/

  slidebox.addEventListener('slideend', setHeader);

  xtag.addEvents(document, {
    'tap:delegate(x-appbar > div:first-child)': function(){
      shiftbox.toggle();
    },
    'tap:delegate(x-appbar > div:last-child)': function(){
      var selected = slidebox.querySelector('x-slide[selected]').firstElementChild;
      var t = new Task();
      t.text = selected.filter;
      t.setAttribute('template','task-edit');
      selected.insertBefore(t, selected.firstElementChild);
    },
    'tap:delegate(#sideMenu > button)': function(e){
      switch(e.target.dataset.action){
        case 'new-column':
            modal.firstElementChild.setAttribute('template', 'new-column');
            modal.toggle();
          break;
        default:
          break;
      }
    }
  });


  function setHeader(){
    var selected = slidebox.querySelector('x-slide[selected]');
    if (!selected && slidebox.querySelectorAll('x-slide')[0]) {
      selected = slidebox.querySelectorAll('x-slide')[0]
      selected.setAttribute('selected','');
    }
    selected = selected.firstElementChild;
    appbar.heading = selected.name;
    appbar.subheading = '(' + selected.children.length + ')';
    appbar.style.backgroundColor = selected.headerColor;
  }

  function createColumn(name, filter, color){
    var column = new TaskFilter();
    column.name = name;
    column.filter = filter;
    column.headerColor = color;
    var slide = document.createElement('x-slide');
    slide.appendChild(column);
    slidebox.firstElementChild.appendChild(slide);
  }

  Hammer(slidebox).on('swipeleft', function(e){
    slidebox.slideNext();
  }).on('swiperight', function(e){
    slidebox.slidePrevious();
  }).on('hold', function(e){
    var t = e.target;
    while(['X-TASK','BODY'].indexOf(t.nodeName)==-1){
      t = t.parentNode;
    }
    if (t.nodeName == 'X-TASK'){
      t.setAttribute('template','task-edit');
    }
  });

  Hammer(appbar.children[1]).on('hold', function(e){
    console.log('header hold');
  });

</script>
</html>